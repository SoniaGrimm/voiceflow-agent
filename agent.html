<script type="text/javascript">
  // 1) Lire les paramètres d'URL
  const qs = new URLSearchParams(window.location.search);

  const targetFlow = qs.get('agent')   || '';
  const email      = qs.get('email')   || '';
  const prenom     = qs.get('prenom')  || '';
  const age        = qs.get('age')     || '';
  const sexe       = qs.get('sexe')    || '';

  // Debug: log tout ce qu’on a reçu
  console.log("[DEBUG] URL params:", qs.toString());
  console.log("[DEBUG] targetFlow:", targetFlow);
  console.log("[DEBUG] email:", email);
  console.log("[DEBUG] prenom:", prenom);
  console.log("[DEBUG] age:", age);
  console.log("[DEBUG] sexe:", sexe);

  // 2) Charger le SDK V3
  (function (d, t) {
    const v = d.createElement(t), s = d.getElementsByTagName(t)[0];
    v.onload = function () {
      window.voiceflow.chat.load({
        verify:   { projectID: '68a6e2cc67f49328386b3766' }, 
        url:      'https://general-runtime.voiceflow.com',
        versionID:'production',
        userID:   email || 'guest',   // fallback si vide
        render: {
          mode: 'embedded',
          target: document.getElementById('vf-chat')
        },
        assistant: {
          name: "TAO",
          title: "TAO",
          description: "Bienvenue !",
          color: "#8B42A2",
          image: "https://cm4-production-assets.s3.amazonaws.com/1730303517127-cute-wolf.jpg"
        },
        launch: {
          event: {
            type: 'launch',
            payload: {
              target_flow: targetFlow,
              email: email,
              prenom: prenom,
              age: age,
              sexe: sexe
            }
          }
        }
      }).then(() => {
        console.log("✅ Webchat V3 chargé, payload envoyé.");
      });
    };
    v.src  = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
    v.type = 'text/javascript';
    s.parentNode.insertBefore(v, s);
  })(document, 'script');
</script>
